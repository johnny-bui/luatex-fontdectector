\documentclass[12pt,a4paper]{article}
\usepackage{luacode,luaotfload}
\usepackage{fontspec}
\usepackage{geometry}
%\usepackage{a4wide}
\usepackage{layout}

\geometry{
  margin=2cm
}
\author{Hong Phuc Bui}
\date{27.06.2013}
\begin{document}


\begin{luacode}

function contains(t, e)
	for i = 1,#t do
		if t[i] == e then return true end
	end
	return false
end

tabu_font = {
"MnSymbol12", "MnSymbol10", "MnSymbol9","MnSymbol8","MnSymbol7","MnSymbol6", "MnSymbol5",
"MnSymbol-Bold5","MnSymbol-Bold6","MnSymbol-Bold7", "MnSymbol-Bold8","MnSymbol-Bold9","MnSymbol-Bold10", "MnSymbol-Bold12",
"blsy",
"SkakNew-Diagram","SkakNew-Figurine","SkakNew-Figurine","SkakNew-DiagramT",
"ocrb8","ocrb9","ocrb10","ocrb6","ocrb7","ocrb5",
"rblmi"}

function foreachinorder(t, f, cmp)
    -- first extract a list of the keys from t
    local font_list = {}
    local font_family = {}
    for k,v in ipairs(t) do
		if not contains(tabu_font, v.fontname) then
			--font_key[#font_key+1] = v.fontname
			--font_list[v.fontname] = v.familyname
			--print(v.fontname)
			--print(v.fontname, v.familyname)
			if font_family[1] == nil then
				print ("init font_family")
				font_family[1] = v.familyname
				font_list[v.familyname] = {v.fontname}
			end
			local font_name = v.fontname
			local last_family_name = v.familyname
			print("name ", font_name , " family ", last_family_name)
			if (contains(font_family, v.familyname)) then
				print("", font_name , " to family ", last_family_name)
				local font_tab = font_list[last_family_name]
				if not contains(font_tab, font_name) then
					font_tab[#font_tab +1] = font_name
				end
			else
				print ("insert new font family ", v.familyname)
				font_family[#font_family+1] = v.familyname
				print ("add ", font_name , "to family", v.familyname)
				font_list[v.familyname] = {font_name}
			end
		end
    end
    
    table.sort(font_family,cmp)
    
    -- finally, loop over the keys in sorted order, and operate
    -- on elements of t
    local i = 0
    local max =1000
    for _ , k in ipairs(font_family) do
		local font_name = font_list[k]
		print("family", k)
		for _, font in ipairs(font_name) do
			-- print (" " , k, "fn:" , font)
			f(i, k,font)
			print(i)
			i = i + 1
			if i > max then 
				return
			end
		end
    end
end

function print_font(index, familyname, fontname)
	familyname_code = "\\fontspec[Ligatures=TeX]{Inconsolata}" .. index .. "." .. familyname
	tex.print(familyname_code)
	tex.print(',')
	text_code =  "\\fontspec[Ligatures=TeX]{" .. fontname .. "}" .. fontname
	-- text_code =  "\\texttt{" .. v.fontname .. "}"
	-- print(text_code)
	tex.print(text_code)
	tex.print('\\par')
end

function str_sort(a, b)
	return string.lower(a) < string.lower(b)
end
\end{luacode}

\begin{luacode}

myfonts=dofile(fonts.names.path.path)

foreachinorder(myfonts.mappings, print_font, str_sort)


\end{luacode}

\end{document}