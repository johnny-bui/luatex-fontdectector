\documentclass[12pt,a4paper]{article}
\usepackage{luacode,luaotfload}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{tikz}
\usetikzlibrary{arrows,calc,positioning,shapes.geometric}
%\usepackage{a4wide}
\usepackage{layout}

\geometry{
  margin=2cm
}
\author{Hong Phuc Bui}
\date{27.06.2013}
\begin{document}


\begin{luacode*}

dofile("makeline.lua")

function contains(t, e)
	for i = 1,#t do
		if t[i] == e then return true end
	end
	return false
end

tabu_font = {
"MnSymbol12", "MnSymbol10", "MnSymbol9","MnSymbol8","MnSymbol7","MnSymbol6", "MnSymbol5",
"MnSymbol-Bold5","MnSymbol-Bold6","MnSymbol-Bold7", "MnSymbol-Bold8","MnSymbol-Bold9","MnSymbol-Bold10", "MnSymbol-Bold12",
"blsy",
"SkakNew-Diagram","SkakNew-Figurine","SkakNew-Figurine","SkakNew-DiagramT",
"ocrb8","ocrb9","ocrb10","ocrb6","ocrb7","ocrb5",
"rblmi",
"Bitter-Italic","Bitter-Bold",
"STIXGeneral-Bold","STIXGeneral-Italic","STIXGeneral-Regular","STIXGeneral-BoldItalic",
"SteveHand"
}

function foreachinorder(t, f, g, cmp)
    -- first extract a list of the keys from t
    local font_list = {}
    local font_family = {}
    for k,v in ipairs(t) do
		if not contains(tabu_font, v.fontname) then
			--font_key[#font_key+1] = v.fontname
			--font_list[v.fontname] = v.familyname
			--print(v.fontname)
			--print(v.fontname, v.familyname)
			if font_family[1] == nil then
				print ("init font_family")
				font_family[1] = v.familyname
				font_list[v.familyname] = {v.fontname}
			end
			local font_name = v.fontname
			local last_family_name = v.familyname
			print("name ", font_name , " family ", last_family_name)
			if (contains(font_family, v.familyname)) then
				print("", font_name , " to family ", last_family_name)
				local font_tab = font_list[last_family_name]
				if not contains(font_tab, font_name) then
					font_tab[#font_tab +1] = font_name
				end
			else
				print ("insert new font family ", v.familyname)
				font_family[#font_family+1] = v.familyname
				print ("add ", font_name , "to family", v.familyname)
				font_list[v.familyname] = {font_name}
			end
		end
    end
    
    table.sort(font_family,cmp)
    
    -- finally, loop over the keys in sorted order, and operate
    -- on elements of t
    local i = 1
    local max = 800
    for _ , k in ipairs(font_family) do
		local font_name = font_list[k]
		f(k)
		table.sort(font_name,cmp)
		for _, font in ipairs(font_name) do
			-- print (" " , k, "fn:" , font)
			g(font)
			--print(i)
			i = i + 1
			if i > max then 
				return
			end
		end
    end
end

function str_sort(a, b)
	return string.lower(a) < string.lower(b)
end


function tex_font_family(font_family)
	print(font_family)
	local section = string.format([[
\section{%s}
]], font_family)
	file:write(section)
	--tex.print("\\hfill\\\\")
end

function tex_font_name(font_name)
	print("",font_name)

	local subsection = string.format("\\subsection{%s}\n",font_name)
	print(subsection)
	file:write(subsection)

	local set_font_code = string.format([[\fontspec[Ligatures=TeX,Scale=1]{%s}]], font_name)
	file:write(set_font_code)
	-- local latex_code = set_font_code .. "\n"
	--local lower = makeline("abcdefghijklmnopqrstuvwxyz",7, function(a) end ) .. "\n"
	--file:write(lower)
	--local upper = makeline("ABCDEFGHIJKLMNOPQRSTUVWXYZ",7, function(a) end ) .. "\n"
	--file:write(upper)
	--digits = makeline({"0","1","\\_", "\\%", "\\&", "ä", "ö", "ü", "ß"},5, function(a) end ) .. "\n"
	-- file:write(digits)
	file:write(make_probe_text())
end

\end{luacode*}


\textnormal{Font list}


\begin{luacode*}

myfonts=dofile(fonts.names.path.path)
file = io.open("temp.tex", "w")
file:write(doc_prefix)
foreachinorder(myfonts.mappings, tex_font_family, tex_font_name, str_sort)
file:write(doc_suffix)


\end{luacode*}

\end{document}
