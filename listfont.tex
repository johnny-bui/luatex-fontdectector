\documentclass[12pt,a4paper]{article}
\usepackage{luacode,luaotfload}
\usepackage{fontspec}


\begin{document}
\begin{luacode*}

local max = 50

dofile("makeline.lua")



tabu_font = {
"MnSymbol12", "MnSymbol10", "MnSymbol9","MnSymbol8","MnSymbol7","MnSymbol6", "MnSymbol5",
"MnSymbol-Bold5","MnSymbol-Bold6","MnSymbol-Bold7", "MnSymbol-Bold8","MnSymbol-Bold9","MnSymbol-Bold10", "MnSymbol-Bold12",
"blsy",
"SkakNew-Diagram","SkakNew-Figurine","SkakNew-Figurine","SkakNew-DiagramT",
"ocrb8","ocrb9","ocrb10","ocrb6","ocrb7","ocrb5",
"rblmi",
"Bitter-Italic","Bitter-Bold",
--"STIXGeneral-Bold","STIXGeneral-Italic","STIXGeneral-Regular","STIXGeneral-BoldItalic",
--"SteveHand"
}

function foreachinorder(t, cmp)
    -- first extract a list of the keys from t
    local font_list = {}
    local font_family = {}
    for k,v in ipairs(t) do
		if font_family[1] == nil then
			print ("init font_family")
			font_family[1] = v.familyname
			font_list[v.familyname] = {v.fontname}
		end
		local font_name = v.fontname
		local last_family_name = v.familyname
		print("name ", font_name , " family ", last_family_name)
		if (contains(font_family, v.familyname)) then
			print("", font_name , " to family ", last_family_name)
			local font_tab = font_list[last_family_name]
			if not contains(font_tab, font_name) then
				font_tab[#font_tab +1] = font_name
			end
		else
			print ("insert new font family ", v.familyname)
			font_family[#font_family+1] = v.familyname
			print ("add ", font_name , "to family", v.familyname)
			font_list[v.familyname] = {font_name}
		end
    end
    
    table.sort(font_family,cmp)
    return font_family, font_list
end



function tex_font_family(font_family)
	print(font_family)
	local section = string.format([[
\section{%s}
]], font_family)
	file:write(section)
	--tex.print("\\hfill\\\\")
end

function tex_font_name(font_name)
	print("",font_name)

	local subsection = string.format(subsection_toc,font_name,font_name)
	print(subsection)
	file:write(subsection)

	local set_font_code = string.format([[\fontspec[Ligatures=TeX,Scale=1]{%s}]], font_name)
	file:write(set_font_code)
	file:write(make_probe_text())
end


myfonts=dofile(fonts.names.path.path)

local out_dir_name = "./texfont/%s.tex"
temp_fn = string.format(out_dir_name,"temp")
file = io.open(temp_fn, "w")
file:write(string.format(doc_prefix,"Font-List"))
font_family, font_list = foreachinorder(myfonts.mappings, str_sort)


local i = 1
for _ , k in ipairs(font_family) do
	if not contains(tabu_font, k) then
		local font_face= font_list[k]
		tex_font_family(k)
		table.sort(font_face,cmp)
		for _, font in ipairs(font_face) do
			print (" " , k, "fn:" , font)
				tex_font_name(font)
				print(i)
				i = i + 1
			if i > max then 
				break
			end
		end
		if i > max then break end
	end
end

file:write(doc_suffix)
file:close()

--lua_cmd = string.format("lualatex -interaction nonstopmode -output-directory=texfont %s", temp_fn)
--print(lua_cmd)
--r = os.execute(lua_cmd)
--print("return value", r)
--if (r == 0) then
	--r = os.execute(lua_cmd)
	--r = os.execute(lua_cmd)
--else
--	print ("call lualatex returned not null valu not null valuee:",r)
--end


for i,k in ipairs(font_family) do
	if not contains(tabu_font, k) then
		local font_face=font_list[k]
		local file_name = k:gsub("%s+","_")
		local tex_file = io.open(string.format(out_dir_name,file_name),"w")
		write_glyphen_test_file(k,font_face,tex_file)
		if  i >= max then break end
	end
end

--compile_all_tex = [[for f in `ls texfont/*.tex` ; do lualatex -output-directory=texfont -interaction nonstopmode $f &  done]]
--local r = os.execute(compile_all_tex)
--print("return value", r)
--if (r == 0) then
--	r = os.execute(lua_cmd)
--	r = os.execute(lua_cmd)
--else
--	print ("call lualatex returned not null valu not null valuee:",r)
--end

\end{luacode*}
\end{document}



